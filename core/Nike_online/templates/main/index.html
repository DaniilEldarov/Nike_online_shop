{% extends 'base.html' %}
{% load static %}

{% block content %}
    <!-- Слайдер -->
    <div class="slider-area">
        <div class="slider-active">
            <div class="single-slider slider-height" data-background="{% static 'assets/img/hero/h1_hero.jpg' %}">
                <div class="container">
                    <div class="row d-flex align-items-center justify-content-between">
                        <div class="col-xl-5 col-lg-5 col-md-5 col-sm-8">
                            <div class="hero__caption">
                                <span data-animation="fadeInRight" data-delay=".4s">60% Discount</span>
                                <h1 data-animation="fadeInRight" data-delay=".6s">Летняя <br> Коллекция</h1>
                                <p data-animation="fadeInRight" data-delay=".8s">Best Cloth Collection By 2025!</p>
                                <div class="hero__btn" data-animation="fadeInRight" data-delay="1s">
                                    <a href="industries.html" class="btn hero-btn">Shop Now</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Категории -->
    <section class="category-area section-padding30">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <div class="section-tittle text-center mb-85">
                        <h2>Shop by Category</h2>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xl-4 col-lg-6">
                    <div class="single-category mb-30">
                        <div class="category-img fixed-img">
                            <img src="{% static 'assets/img/categori/cat1.jpg' %}" alt="">
                            <div class="category-caption">
                                <h2>Sneakers</h2>
                                <span class="best"><a href="#">Best New Deals</a></span>
                                <span class="collection">New Collection</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4 col-lg-6">
                    <div class="single-category mb-30">
                        <div class="category-img fixed-img">
                            <img src="{% static 'assets/img/categori/cat2.jpg' %}" alt="">
                            <div class="category-caption">
                                <h2>Discount!</h2>
                                <span class="collection">New Collection</span>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="col-xl-4 col-lg-6">
                    <div class="single-category mb-30">
                        <div class="category-img fixed-img">
                            <img src="{% static 'assets/img/categori/cat3.jpg' %}" alt="">
                            <div class="category-caption">
                                <h2>Men’s Cloth</h2>
                                <span class="best"><a href="#">Best New Deals</a></span>
                                <span class="collection">New Collection</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Фильтры и поиск -->
    <section class="latest-product-area padding-bottom">
        <div class="container">
            <div class="row mb-4">
                <div class="col-md-6">
                    <select class="form-control" id="sort-selector">
                        <option value="">Сортировка</option>
                        <option value="price_asc">От дешевых</option>
                        <option value="price_desc">От дорогих</option>
                        <option value="rating">По рейтингу</option>
                        <option value="newest">Сначала новые</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control" id="search-input" placeholder="Поиск товаров...">
                </div>
            </div>

            <div class="row product-btn d-flex justify-content-end align-items-end">
                <div class="col-xl-4 col-lg-5 col-md-5">
                    <div class="section-tittle mb-30">
                        <h2>Latest Products</h2>
                    </div>
                </div>
                <div class="col-xl-8 col-lg-7 col-md-7">
                    <div class="properties__button f-right">
                        <nav>
                            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                                <a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">All</a>
                                <a class="nav-item nav-link" id="nav-profile-tab" data-toggle="tab" href="#nav-profile" role="tab" aria-controls="nav-profile" aria-selected="false">New</a>
                                <a class="nav-item nav-link" id="nav-contact-tab" data-toggle="tab" href="#nav-contact" role="tab" aria-controls="nav-contact" aria-selected="false">Featured</a>
                                <a class="nav-item nav-link" id="nav-last-tab" data-toggle="tab" href="#nav-last" role="tab" aria-controls="nav-contact" aria-selected="false">Offer</a>
                            </div>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Карточки товаров -->
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
                   <div class="row">
                        {% for product in products %}
                            <div class="col-xl-4 col-lg-4 col-md-6">
                                <div class="single-product mb-60">
                                    <div class="product-img" style="position: relative;">
                                        <a href="{% url 'detail' product.id %}">
                                            {% if product.images.first %}
                                                <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" style="width: 100%; height: 300px; object-fit: cover;">
                                            {% elif product.image %}
                                                <img src="{{ product.image.url }}" alt="{{ product.name }}" style="width: 100%; height: 300px; object-fit: cover;">
                                            {% else %}
                                                <img src="{% static 'assets/img/placeholder.jpg' %}" alt="No image" style="width: 100%; height: 300px; object-fit: cover;">
                                            {% endif %}
                                        </a>
                                        {% if product.is_new %}
                                        <div class="new-product">
                                            <span>New</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="product-caption">
                                        <div class="product-ratting" data-product-id="{{ product.id }}">
                                            {% for i in "12345" %}
                                                {% if product.average_rating >= forloop.counter %}
                                                    <i class="fas fa-star rating-star" data-value="{{ forloop.counter }}"></i>
                                                {% else %}
                                                    <i class="far fa-star rating-star" data-value="{{ forloop.counter }}"></i>
                                                {% endif %}
                                            {% endfor %}
                                            <span class="rating-count">({{ product.ratings.count }})</span>
                                        </div>
                                        <h4><a href="{% url 'detail' product.id %}">{{ product.name }}</a></h4>
                                        <div class="price">
                                            <ul>
                                                <li>{{ product.price }} сом</li>
                                                {% if product.discount_price %}
                                                <li class="discount">{{ product.discount_price }} сом</li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <p>Нет товаров.</p>
                        {% endfor %}
                   </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
<script>
// Система рейтинга
document.querySelectorAll('.rating-star').forEach(star => {
    star.addEventListener('click', function() {
        const productId = this.closest('.product-ratting').dataset.productId;
        const ratingValue = this.dataset.value;

        fetch(`/rate-product/${productId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({rating: ratingValue})
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                location.reload();
            }
        });
    });
});

// Фильтрация товаров
document.getElementById('sort-selector').addEventListener('change', function() {
    const value = this.value;
    if(value) {
        window.location.search = `?sort=${value}`;
    }
});

// Поиск товаров
document.getElementById('search-input').addEventListener('keyup', function(e) {
    if(e.key === 'Enter') {
        const query = this.value.trim();
        if(query) {
            window.location.search = `?search=${query}`;
        }
    }
});
</script>
{% endblock %}